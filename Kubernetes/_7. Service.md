쿠버네티스에서 애플리케이션은 **Pod**라는 단위로 실행됩니다. Pod는 애플리케이션 컨테이너를 감싸고 있으며, 필요한 리소스를 함께 제공합니다.

그러나 Pod는 다음과 같은 한계를 가지고 있습니다:

- **IP 주소의 불안정성**:  
    Pod는 생성될 때마다 새로운 IP 주소를 받습니다.  
    만약 Pod가 삭제되거나 다시 생성되면, 기존의 IP 주소는 더 이상 유효하지 않습니다.  
    → **Pod에 직접 접근하려는 클라이언트는 항상 새로운 IP를 알아야 하는 문제**가 생깁니다.
    
- **동적 변화**:  
    애플리케이션이 확장되거나 업데이트될 때, Pod의 수와 위치가 계속 바뀝니다.  
    → 클라이언트가 특정 Pod에만 의존하면, 시스템이 불안정해질 수 있습니다.

**Service는 Pod들을 묶어서 하나의 고정된 네트워크 주소(엔드포인트)를 제공하는 쿠버네티스의 추상화된 개념**입니다.  
이를 통해 클라이언트는 Pod의 IP 주소가 바뀌더라도 항상 같은 주소로 애플리케이션에 접근할 수 있습니다.

### Service의 역할

1. **Pod들에 대한 단일 진입점 제공**:  
    여러 Pod를 하나의 논리적인 그룹으로 묶고, 고정된 IP 주소 또는 DNS 이름을 제공합니다.  
    클라이언트는 변경되는 Pod의 IP를 신경 쓸 필요 없이 Service를 통해 접근할 수 있습니다.
    
2. **로드 밸런싱**:  
    Service는 클라이언트의 요청을 연결된 여러 Pod에 분산시켜줍니다.  
    이를 통해 트래픽이 균등하게 처리되고, 특정 Pod에 과부하가 걸리는 것을 방지합니다.
    
3. **Pod의 동적 변화 관리**:  
    Pod가 삭제되거나 새로 생성되더라도, Service는 자동으로 이를 감지하고 최신 Pod 집합에 접근할 수 있도록 보장합니다.

### 동작 방식

- Service는 `selector`를 사용하여 연결할 Pod를 결정합니다.
- Service는 연결된 Pod의 IP와 포트를 **Endpoints** 객체로 관리합니다.
- Endpoints는 Service와 Pod 간의 연결 상태를 실시간으로 업데이트합니다.

4. **Pod 정의**
- 먼저, Service가 연결할 Pod를 정의합니다. Pod는 각기 다른 애플리케이션 컨테이너를 실행하며, `app: my-app`이라는 레이블을 가지고 있습니다.
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: my-app-pod-1
  labels:                # Pod에 레이블을 붙입니다.
    app: my-app          # Service가 이 레이블을 기준으로 Pod를 선택합니다.
spec:
  containers:
    - name: my-container
      image: nginx       # nginx 컨테이너 실행
      ports:
        - containerPort: 8080
```

5. **Service 정의**
	- 이제 위 Pod와 연결될 **Service**를 정의합니다. Service는 `selector`를 사용해 Pod를 선택하고, 클라이언트 요청을 적절한 Pod로 전달합니다.
	- **설명**:
		- `selector`: `app: my-app` 레이블을 가진 Pod만 이 Service에 연결됩니다.
		- `port`: 클라이언트가 Service에 요청을 보낼 때 사용하는 포트(80).
		- `targetPort`: Pod 내부에서 컨테이너가 사용하는 포트(8080).
		- `type: ClusterIP`: 클러스터 내부에서만 접근 가능한 기본 Service 유형입니다.
```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service       # Service의 이름
spec:
  selector:              # Service가 연결할 Pod를 선택하는 기준
    app: my-app          # Pod의 레이블 중 app: my-app을 가진 Pod만 선택
  ports:
    - protocol: TCP
      port: 80           # 클라이언트가 접근할 포트
      targetPort: 8080   # Pod 내부에서 컨테이너가 사용하는 포트
  type: ClusterIP        # 클러스터 내부에서만 접근 가능한 Service
```

6. **Endpoints 관리**
	- 쿠버네티스는 위 Service와 연결된 Pod들의 IP 주소와 포트를 **Endpoints**라는 객체로 관리합니다.
	- 대부분의 경우, Endpoints는 Service에 의해 자동으로 생성되므로 별도로 정의할 필요가 없습니다.
	- 이 Endpoints는 Service가 연결된 Pod의 상태를 실시간으로 추적하며, Pod가 추가되거나 삭제되면 자동으로 업데이트됩니다.
	- Service는 이 Endpoints를 참조하여 클라이언트 요청을 적절한 Pod로 전달합니다.
	- Pod가 삭제되거나 새로 생성되면, Endpoints가 자동으로 업데이트됩니다.
```yaml
apiVersion: v1
kind: Endpoints
metadata:
  name: my-service
subsets:
  - addresses:
      - ip: 10.244.0.5   # Pod 1의 IP
      - ip: 10.244.0.6   # Pod 2의 IP
    ports:
      - port: 8080       # Pod에서 열려 있는 포트
```

7. **클라이언트 요청 처리**
	- 클라이언트가 `my-service`라는 이름의 Service에 요청을 보낼 때의 동작 흐름은 다음과 같습니다:
		1. 클라이언트는 `http://my-service:80`으로 요청을 보냅니다.
		2. Service는 요청을 받아 `Endpoints`를 참조하여 연결된 Pod 중 하나를 선택합니다.
		3. 요청은 선택된 Pod의 `targetPort: 8080`으로 전달됩니다.
		4. Pod는 요청을 처리하고 결과를 클라이언트로 반환합니다.


### Service 유형

사용 사례에 따라 각 Service 유형을 선택할 수 있습니다.

8. **ClusterIP (기본값)**
	- `ClusterIP`는 클러스터 내부에서만 접근 가능한 Service 유형입니다.
	- 클러스터 내에서 고정된 IP 주소를 제공하며, 외부에서는 접근할 수 없습니다.
	- 클러스터 내부의 다른 Pod나 컴포넌트가 해당 Service를 통해 연결됩니다.
	- 내부 애플리케이션 간 통신, 백엔드 서비스(예: 데이터베이스) 등 외부에 노출될 필요가 없는 서비스에 적합합니다.
```yaml
apiVersion: v1
kind: Service
metadata:
  name: clusterip-service
spec:
  selector:
    app: my-app
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
  type: ClusterIP
```

9. **NodePort**
	- `NodePort`는 클러스터 외부에서도 접근할 수 있는 Service 유형입니다.
	- 각 노드의 특정 포트를 열어 외부 요청을 처리하며, 클라이언트는 노드의 IP 주소와 지정된 포트를 통해 Service에 접근할 수 있습니다.
	- 노드의 포트는 `30000-32767` 범위 내에서 지정됩니다.
	- 간단한 테스트 환경에서 외부 트래픽을 처리하거나, 클라우드 로드 밸런서 없이 외부 접근이 필요한 경우 적합합니다.
	- 외부 사용자는 `노드의 IP:NodePort` 형태로 접근합니다.
		- 예: `http://<노드 IP>:30001`
	- 클러스터 내부에서는 NodePort 대신 Service 이름으로 접근합니다.
		- 예: `http://nodeport-service:80`
```yaml
apiVersion: v1
kind: Service
metadata:
  name: nodeport-service
spec:
  selector:
    app: my-app
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
      nodePort: 30001 # 노드에서 열리는 포트
  type: NodePort
```

10. **LoadBalancer**
	- 클라이언트는 로드 밸런서의 IP 주소를 통해 Service에 접근할 수 있으며, 로드 밸런서는 내부적으로 Pod로 요청을 분산시킵니다.
	- 클라우드 환경에서만 사용 가능(GCP, AWS, Azure 등).
	- 외부에 노출되어야 하는 웹 애플리케이션, API 서버 등에 적합합니다.
```yaml
apiVersion: v1
kind: Service
metadata:
  name: loadbalancer-service
spec:
  selector:
    app: my-app
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
  type: LoadBalancer
```

11. **ExternalName**
	- DNS 이름을 외부 서비스로 매핑하며, 클라이언트는 Service 이름을 사용해 외부의 도메인 이름에 접근할 수 있습니다.
	- 클러스터 외부에 있는 데이터베이스, 외부 API 서버 등과 통신할 때 적합합니다.
```yaml
apiVersion: v1
kind: Service
metadata:
  name: externalname-service
spec:
  type: ExternalName
  externalName: example.com # 외부 DNS 이름
```


